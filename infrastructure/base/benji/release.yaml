---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: benji
  namespace: benji
spec:
  releaseName: benji
  chart:
    spec:
      chart: ./charts/benji-k8s
      sourceRef:
        kind: GitRepository
        name: benji-charts
        namespace: flux-system
  interval: 1h0m0s
  install:
    remediation:
      retries: 5
  # Default Values https://github.com/elemental-lf/benji/blob/master/charts/benji-k8s/values.yaml
  values:
    timeZone: America/Los_Angeles
    benji:
      image:
        registry: ghcr.io
        repository: elemental-lf/benji-k8s
        tag: 0.15.0
        pullPolicy: IfNotPresent
      volumes:
        - name: k8s-backup
          persistentVolumeClaim:
            claimName: k8s-nfs-backup-pvc
      volumeMounts:
        - name: k8s-backup
          mountPath: /backup-nfs
      crontab:
        - name: backup-all
          schedule: "*/10 * * * *"
          command:
            - benji-backup-pvc
        - name: enforce
          schedule: "00 04 * * *"
          command:
            - benji-command
            - enforce
            - latest3,hours24,days30,months3
            - 'labels["benji-backup.me/instance"] == "benji-k8s"'
        - name: cleanup
          schedule: "00 05 * * *"
          command:
            - benji-command
            - cleanup
