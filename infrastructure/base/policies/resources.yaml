---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: limit-resources
  annotations:
    policies.kyverno.io/title: Allowed Resources
    policies.kyverno.io/severity: medium
    policies.kyverno.io/description: >-
      Create an allow list of allowed resources. This can help with version
      upgrades or deprecations, or more generally keeping the state of the
      cluster in check.
spec:
  validationFailureAction: audit
  failurePolicy: Ignore
  background: false
  rules:
  - name: allowlist
    match:
      any:
      - resources:
          kinds:
          - "*"
    preconditions:
      all:
      - key: "{{ request.operation || 'BACKGROUND' }}"
        operator: NotEquals
        value: DELETE
      - key:
        - "{{request.object.apiVersion}}"
        operator: AllNotIn
        value:
        - v1
        - apps/v1
        - batch/v1
        - monitoring.grafana.com/v1alpha1
        - monitoring.coreos.com/v1
      - key:
        - "{{request.object.apiVersion}} {{ request.object.kind }}"
        operator: AllNotIn
        value:
        # Flux & Helm
        - helm.toolkit.fluxcd.io/v2beta1 HelmRelease
        - kustomize.toolkit.fluxcd.io/v1 Kustomization
        - notification.toolkit.fluxcd.io/v1beta2 Alert
        - notification.toolkit.fluxcd.io/v1beta2 Provider
        - notification.toolkit.fluxcd.io/v1 Receiver
        - source.toolkit.fluxcd.io/v1 GitRepository
        - source.toolkit.fluxcd.io/v1beta2 HelmRepository
        # Terraform
        - infra.contrib.fluxcd.io/v1alpha1 Terraform
        # Ceph
        - ceph.rook.io/v1 CephCluster
        - cert-manager.io/v1 ClusterIssuer
        # Networking & Services
        - kyverno.io/v1 ClusterPolicy
        - networking.istio.io/v1alpha3 EnvoyFilter
        - metallb.io/v1beta1 IPAddressPool
        - metallb.io/v1beta1 L2Advertisement
        # k8s
        - admissionregistration.k8s.io/v1 MutatingWebhookConfiguration
        - admissionregistration.k8s.io/v1 ValidatingWebhookConfiguration
        - autoscaling/v2 HorizontalPodAutoscaler
        - apiextensions.k8s.io/v1 CustomResourceDefinition
        - coordination.k8s.io/v1 Lease
        - networking.k8s.io/v1 Ingress
        - networking.k8s.io/v1 IngressClass
        - networking.k8s.io/v1 NetworkPolicy
        - policy/v1beta1 PodDisruptionBudget
        - policy/v1beta1 PodSecurityPolicy
        - policy/v1 PodDisruptionBudget
        - rbac.authorization.k8s.io/v1 ClusterRole
        - rbac.authorization.k8s.io/v1 ClusterRoleBinding
        - rbac.authorization.k8s.io/v1 Role
        - rbac.authorization.k8s.io/v1 RoleBinding
        - storage.k8s.io/v1 StorageClass
        - snapshot.storage.k8s.io/v1 VolumeSnapshot
        - snapshot.storage.k8s.io/v1 VolumeSnapshotClass
    validate:
      message: "{{ request.object.apiVersion }}/{{ request.object.kind }} is not in allowlist"
      deny: {}
