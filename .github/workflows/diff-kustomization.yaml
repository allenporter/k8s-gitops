name: Diff Flux Kustomizations
on:
  pull_request:
    branches:
      - main
    paths:
      - "**.yaml"
env:
  conf_live_branch: main
jobs:
  diffs:
    name: Kustomization diff
    runs-on: ubuntu-latest
    outputs:
      diff_output: "${{ steps.diff.outputs.kustomizations }}"
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          path: pr
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r pr/requirements.txt
      - name: Checkout live branch
        uses: actions/checkout@v3
        with:
          ref: ${{ env.conf_live_branch }}
          path: live
      - name: flux-local diff ks
        id: diff
        run: |
          cd pr && flux-local diff ks -o yaml --unified 6 --path-orig ../live > kustomization-diffs.yaml
          delimiter="$(openssl rand -hex 8)"
          diffs=$(yq '.[] | {path: .path, namespace: .namespace, name: .name}' kustomization-diffs.yaml | jq -s '.')
          echo "kustomizations<<${delimiter}" >> $GITHUB_OUTPUT
          echo "${diffs}" >> $GITHUB_OUTPUT
          echo "${delimiter}" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v3
        with:
          name: kustomization-diffs
          path: pr/kustomization-diffs.yaml

  kustomization:
    name: Kustomization
    runs-on: ubuntu-latest
    needs:
      - diffs
    strategy:
      matrix:
        kustomization: ${{ fromJson(needs.diffs.outputs.diff_output) }}
      fail-fast: false
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: kustomization-diffs
      - name: read kustomization diff
        id: diff
        run: |
          kustomization_data=$(cat kustomization-diffs.yaml | yq -j | jq -c '.[] | select(.path == "infrastructure/prod")' | jq -r '.diffs[].diff_markdown + "\n"'

          echo ${kustomization_data}
          echo "kustomization_data=${kustomization_data}" >> $GITHUB_ENV

      - name: PR Comments
        uses: mshick/add-pr-comment@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          message-id: ${{ matrix.kustomization.path }}
          message-failure: Unable to post kustomization diff
          message: ${{ env.kustomization_data }}
