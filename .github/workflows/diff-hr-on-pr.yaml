name: Diff HelmReleases
on:
  pull_request:
    branches:
      - main
      - "rennovate/**"
    paths:
      - "clusters/**.yaml"
env:
  conf_live_branch: main
  conf_allow_repeating_same_comment: true
jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      files: "${{ steps.extract.outputs.files }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Get changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          list-files: shell
          filters: |
            changed:
              - '**'
      - name: Keep HelmReleases only
        id: extract
        run: |
          filtered=$(grep -zl "kind: HelmRelease.*registryUrl=" ${{ steps.filter.outputs.changed_files }} | \
            jq -R '[.]' | \
            jq -s -c add)
          echo ::set-output name=files::${filtered}
  helm:
    name: Template HelmReleases
    runs-on: ubuntu-latest
    needs:
      - changes
    strategy:
      matrix:
        file: ${{ fromJson(needs.changes.outputs.files) }}
      fail-fast: false
    steps:
      - name: Setup Kubernetes Tools
        uses: yokawasa/action-setup-kube-tools@v0.7.1
        with:
          setup-tools: |
            helmv3
            yq
      - name: Checkout live branch
        uses: actions/checkout@v2
        with:
          ref: ${{ env.conf_live_branch }}
          path: live
      - name: Checkout PR branch
        uses: actions/checkout@v2
        with:
          path: pr
      - name: Create diff
        id: diff
        run: |
          hr_live_url=$(sed -nr 's|.*registryUrl=(.+)$|\1|p' live/${{ matrix.file }})
          hr_live_chart=$(yq e .spec.chart.spec.chart live/${{ matrix.file }})
          hr_live_version=$(yq e .spec.chart.spec.version live/${{ matrix.file }})
          hr_live_values=$(yq e .spec.values live/${{ matrix.file }})
          hr_pr_url=$(sed -nr 's|.*registryUrl=(.+)$|\1|p' pr/${{ matrix.file }})
          hr_pr_chart=$(yq e .spec.chart.spec.chart pr/${{ matrix.file }})
          hr_pr_version=$(yq e .spec.chart.spec.version pr/${{ matrix.file }})
          hr_pr_values=$(yq e .spec.values pr/${{ matrix.file }})
          helm repo add live "$hr_live_url"
          helm repo add pr "$hr_pr_url"
          resources_live=$(echo "$hr_live_values" | \
            helm template "$hr_live_chart" \
            live/"$hr_live_chart" \
            --version "$hr_live_version" -f -)
          echo "$resources_live"
          echo "#####################################################"
          resources_pr=$(echo "$hr_pr_values" | \
            helm template "$hr_pr_chart" \
            pr/"$hr_pr_chart" \
            --version "$hr_pr_version" -f -)
          echo "$resources_pr"
          diff=$((diff -u <(echo "$resources_live") <(echo "$resources_pr") || true) | tail +3)
          echo ::set-output name=diff::$(echo "$diff" | jq --raw-input --slurp '.')
          echo ::set-output name=hr_live_url::$hr_live_url
          echo ::set-output name=hr_live_chart::$hr_live_chart
          echo ::set-output name=hr_live_version::$hr_live_version
          echo ::set-output name=hr_pr_url::$hr_pr_url
          echo ::set-output name=hr_pr_chart::$hr_pr_chart
          echo ::set-output name=hr_pr_version::$hr_pr_version
      - name: Add PR Comment
        uses: mshick/add-pr-comment@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          allow-repeats: ${{ env.conf_allow_repeating_same_comment }}
          message: |
            Path: `${{ matrix.file }}`
            Chart: `${{ steps.diff.outputs.hr_live_chart }}` -> `${{ steps.diff.outputs.hr_pr_chart }}`
            Version: `${{ steps.diff.outputs.hr_live_version }}` -> `${{ steps.diff.outputs.hr_pr_version }}`
            Repo: `${{ steps.diff.outputs.hr_live_url }}` -> `${{ steps.diff.outputs.hr_pr_url }}`
            ```diff
            ${{ fromJSON(steps.diff.outputs.diff) }}
            ```
