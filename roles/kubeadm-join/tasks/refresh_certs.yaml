---
- name: Verify kubeadm installed version
  command: kubeadm version -o short
  register: kubeadm_version
  failed_when: "('v' + k8s_version) != kubeadm_version.stdout"

- name: Create storage for join commands
  file:
    path: "{{ join_cmd_dir }}"
    state: directory
    mode: '0700'
  when: root_node is defined and root_node == "true"

- name: Generate control plane join command
  shell:
    cmd: "kubeadm token create --print-join-command > {{ join_cmd_dir }}/join-cmd"
    # No "creates:" here so that the command always refreshes
  when: root_node is defined and root_node == "true"

- name: Create control-plane certs
  shell:
    cmd: "kubeadm init phase upload-certs --config={{ kubeadm_config }} --upload-certs | tail -1 > {{ join_cmd_dir }}/certificate-key"
    # No "creates:" here so that the command always refreshes
  when: root_node is defined and root_node == "true"