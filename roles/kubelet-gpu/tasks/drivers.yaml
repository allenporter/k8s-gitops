---
- name: Check installed nvdia driver version
  shell: "cat /proc/driver/nvidia/version || echo ' Kernel Module 0.00.00'"
  register: results

- set_fact:
    installed_version: "{{ results.stdout | regex_search(regexp, '\\1') | first }}"
  vars:
    regexp: '.*Kernel Module\s+(\S{3}).*'

- debug:
    var: installed_version
  when:
    - installed_version is defined

- name: Check kernel version
  shell: "uname -r"
  changed_when: False
  register: uname_result

- name: "Install nvidia driver (gpu server driver {{ nvidia_driver_version }})"
  shell: "ubuntu-drivers install --gpgpu nvidia:{{ nvidia_driver_version }}-server"
  when: installed_version != nvidia_driver_version

- name: "Install additional nvidia packages"
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - dkms
    - "nvidia-dkms-{{ nvidia_driver_version }}"
    - "nvidia-utils-{{ nvidia_driver_version }}-server"
    - "linux-headers-{{ uname_result.stdout }}"
  when: installed_version != nvidia_driver_version
