---
- name: Create containerd config directory
  file:
    path: "{{ containerd_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0655'

- name: Check container runtime configuration
  stat:
    path: "{{ containerd_config_file }}"
  register: config_check

- name: Default containerd config
  command: containerd config default
  register: default_config
  when: not config_check.stat.exists

- name: Update containerd configuration
  ansible.builtin.copy:
    content: "{{default_config.stdout}}"
    dest: "{{ containerd_config_file }}"
  when: not config_check.stat.exists
  notify: restart containerd

- name: Update SystemdCgroup
  replace:
    path: "{{ containerd_config_file }}"
    regexp: "SystemdCgroup = false"
    replace: "SystemdCgroup = true"
  when: not config_check.stat.exists
  notify: restart containerd