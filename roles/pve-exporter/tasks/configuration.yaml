---
- name: Create configuration directory
  file:
    path: "{{ config_dir }}"
    state: directory

- name: Configure proxmox-pve-exporter service
  template:
    src: prometheus-pve-exporter.tmpl.service
    dest: /etc/systemd/system/prometheus-pve-exporter.service
  notify: restart prometheus-pve-exporter systemd

- name: Proxmox pve exporter secret
  gcp_secret:
    project: "{{ lookup('ansible.builtin.env', 'GCLOUD_PROJECT_ID') }}"
    secret: "{{ gcp_pve_secret_id }}"
    version: "{{ gcp_pve_secret_version }}"
  register: pve_exporter

- name: Install configuration
  vars:
    secret: "{{ pve_exporter.secret }}"
  template:
    src: pve.tmpl.yaml
    dest: "{{ config_dir }}/pve.yml"
  notify: restart prometheus-pve-exporter systemd