---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: minecraft-proxy
  namespace: minecraft
spec:
  releaseName: minecraft-proxy
  chart:
    spec:
      # renovate: registryUrl=https://itzg.github.io/minecraft-server-charts/
      chart: minecraft-proxy
      version: 3.3.0
      sourceRef:
        kind: HelmRepository
        name: itzg
        namespace: flux-system
  interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    disableWait: true
  test:
    # Fix problem where helm fails to uninstall
    enable: false

  # https://github.com/itzg/minecraft-server-charts/blob/master/charts/minecraft-proxy/values.yaml
  values:
    image:
      repository: itzg/bungeecord
      tag: 2022.4.1
    minecraftProxy:
      type: WATERFALL
      serviceType: LoadBalancer
      externalTrafficPolicy: Local
      config: |
        player_limit: -1
        ip_forward: true
        permissions:
          default:
          - bungeecord.command.server
          - bungeecord.command.list
          - alert.trigger
          - slashserver.lobby
          - slashserver.survival02
          - slashserver.survival03
          - slashserver.creative05
          - slashserver.survival06
          - slashserver.survival07
          - slashserver.survival08
          admin:
          - bungeecord.command.alert
          - bungeecord.command.end
          - bungeecord.command.ip
          - bungeecord.command.reload
          - alert.receive
          - alert.receive.firstjoin
          - alert.command.toggle
          - alert.command.reload
        timeout: 30000
        log_pings: true
        log_commands: false
        online_mode: true
        servers:
          lobby:
            motd: 'Woodgreen Lobby'
            address: mc01.${DOMAIN}:25565
            restricted: false
          survival02:
            motd: 'Survival 02'
            address: mc02.${DOMAIN}:25565
            restricted: false
          survival03:
            motd: 'Survival 03'
            address: mc03.${DOMAIN}:25565
            restricted: false
          creative05:
            motd: 'Creative Flat'
            address: mc05.${DOMAIN}:25565
            restricted: false
          survival06:
            motd: 'Survival 06'
            address: mc06.${DOMAIN}:25565
            restricted: false
          survival07:
            motd: 'Survival 07'
            address: mc07.${DOMAIN}:25565
            restricted: false
          survival08:
            motd: 'Survival 08'
            address: mc08.${DOMAIN}:25565
            restricted: false
        listeners:
        - query_port: 25577
          motd: '&3Woodgreen &6&Llobby'
          priorities:
          - lobby
          bind_local_address: true
          tab_list: GLOBAL_PING
          query_enabled: true
          host: 0.0.0.0:25577
        ping_passthrough: true
    persistence:
      dataDir:
        enabled: true
    extraEnv:
      SPIGET_PLUGINS: "29595"
    serviceAnnotations:
      external-dns.alpha.kubernetes.io/hostname: mc.${DOMAIN}.
