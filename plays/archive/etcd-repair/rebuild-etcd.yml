# Remove and replace a broken cluster member. Should be invoked with only
# one host at a time.
# To get the target run:
# $ etcdctl member list
# Invoke with --extra-vars "target=4251fb4f5da381f5" which is the unique identifier for the member
---

- hosts: cfg
  become: yes
  any_errors_fatal: yes
  tasks:
    - name: Exterminate mankind
      pause:
        prompt: "Please confirm you want to destory {{ etcd_name }} / {{ ansible_host }} / {{ target }} / {{ etcd_ip }}:2380. Press Ctrl+c then 'a' abort"

    - name: Turn off etcd service
      systemd:
        name: etcd
        state: stopped

- hosts: cfg
  tasks:
    - name: Remove member
      command: "etcdctl member remove {{ target }}"
      delegate_to: localhost
      register: remove
      # This is not idempotent, so this can be commented out if a later
      # step fails.
      #ignore_errors: yes

    - debug: var=remove

- hosts: cfg
  become: yes
  become_user: root
  any_errors_fatal: yes
  tasks:
    - name: Backup etcd directory
      copy:
        src: /var/lib/etcd
        dest: "/var/lib/etcd.{{ ansible_date_time.epoch }}"
        remote_src: yes

    - name: Remove etcd/member directory
      file:
        path: "/var/lib/etcd/member"
        state: absent

    - debug: var=remove

- hosts: cfg
  any_errors_fatal: yes
  tasks:
    - name: Add member to cluster
      command: "etcdctl member add {{ etcd_name }} --peer-urls=http://{{ etcd_ip }}:2380"
      delegate_to: localhost
      register: add

    - debug: var=add

- hosts: cfg
  any_errors_fatal: yes
  become: yes
  tasks:
    - name: Restart etcd service
      systemd:
        name: etcd
        enabled: yes
        daemon_reload: yes
        state: restarted
