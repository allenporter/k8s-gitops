# Creates a backup of a VM host based on:
#   https://pve.proxmox.com/wiki/Proxmox_VE_2.0_Cluster#Re-installing_a_cluster_node
---
- name: Collect data from all hosts
  hosts: vmm
  become: yes
  vars:
    backup_dir: "/mnt/pve/vm-backup/hosts"
  vars_prompt:
  - name: backup_prompt
    prompt: "This will stop services to take a backup.  Press return to continue, or ctrl-c to abort"
    private: false
  tasks:

  - shell: date +%Y%m%d%H%M%S
    register: timestamp

  - name: Provision backup dir
    file:
      path: "{{ backup_dir }}"
      mode: '0700'
      state: directory

  #
  # Phase 1: Backup SSH Keys
  #

  - name: Stopping proxmox services
    service:
      name: "{{ item }}"
      state: stopped
    loop:
    - pvestatd
    - pvedaemon

  - name: Backup ssh configuration
    archive:
      path: /root/.ssh
      dest: "{{ backup_dir }}/ssh-{{ ansible_host }}-{{ timestamp.stdout }}.tar.gz"
      format: gz

  #
  # Phase 2: Backup cluster information
  #

  - name: Stopping proxmox services
    service:
      name: "{{ item }}"
      state: stopped
    loop:
    - corosync
    - pve-cluster

  - name: Backup configuration
    archive:
      path: /var/lib/pve-cluster
      dest: "{{ backup_dir }}/pve-{{ ansible_host }}-{{ timestamp.stdout }}.tar.gz"
      format: gz

  - name: Restarting proxmox services
    service:
      name: "{{ item }}"
      state: started
    loop:
    - pvestatd
    - pvedaemon
    - corosync
    - pve-cluster
