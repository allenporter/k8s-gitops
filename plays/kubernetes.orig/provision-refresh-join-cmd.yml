# Refresh a join command so a new node can be added
---

- hosts: kapi
  become: yes
  become_user: root
  vars:
    kubeadm_config: /etc/kubernetes/kubeadm-config.yml
    kubelet_dir: /var/lib/kubelet
    join_cmd_dir: "{{ kubelet_dir }}/join-commands/"
  tasks:
  - name: Copy kubeadm config
    template:
      src: kubeadm-config.yaml.tmpl
      dest: "{{ kubeadm_config }}"
    when: root_node is defined and root_node == "true"

  - name: Create storage for join commands
    file:
      path: "{{ join_cmd_dir }}"
      state: directory
      mode: '0700'
    when: root_node is defined and root_node == "true"

  - name: Generate control plane join command
    shell:
      cmd: "kubeadm token create --print-join-command > {{ join_cmd_dir }}/join-cmd"
      # No "creates:" here so that the command always refreshes
    when: root_node is defined and root_node == "true"

  - name: Create control-plane certs
    shell:
      cmd: "kubeadm init phase upload-certs --config={{ kubeadm_config }} --upload-certs | tail -1 > {{ join_cmd_dir }}/certificate-key"
      # No "creates:" here so that the command always refreshes
    when: root_node is defined and root_node == "true"
