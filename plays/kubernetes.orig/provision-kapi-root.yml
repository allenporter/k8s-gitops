# Configure kubernetes API servers
---
- hosts: kapi,kube
  become: yes
  become_user: root
  vars:
    kubeadm_config: /etc/kubernetes/kubeadm-config.yml
    kubelet_dir: /var/lib/kubelet
    join_cmd_dir: "{{ kubelet_dir }}/join-commands/"
  tasks:
  - name: Copy kubeadm config
    template:
      src: kubeadm-config.yaml.tmpl
      dest: "{{ kubeadm_config }}"
    when: root_node is defined and root_node == "true"

  # Note, run "kubeadm reset" to clear this state
  - name: Initialize control plane root node
    shell:
      cmd: "kubeadm init --config={{ kubeadm_config }} --upload-certs"
      creates: "{{ kubelet_dir }}/config.yaml"
    when: root_node is defined and root_node == "true"

  - name: Create storage for join commands
    file:
      path: "{{ join_cmd_dir }}"
      state: directory
      mode: '0700'
    when: root_node is defined and root_node == "true"

  - name: Create control-plane certs
    shell:
      cmd: "kubeadm init phase upload-certs --config={{ kubeadm_config }} --upload-certs | tail -1 > {{ join_cmd_dir }}/certificate-key"
      creates: "{{ join_cmd_dir }}/certificate-key"
    when: root_node is defined and root_node == "true"

  - name: Generate control plane join command
    shell:
      cmd: "kubeadm token create --print-join-command > {{ join_cmd_dir }}/join-cmd"
      creates: "{{ join_cmd_dir }}/join-cmd"
    when: root_node is defined and root_node == "true"

  - name: Read admin config
    fetch:
      src: /etc/kubernetes/admin.conf
      dest: "~/.kube/{{ groups['kapi'][0] }}.config"
      flat: yes
    when: root_node is defined and root_node == "true"
