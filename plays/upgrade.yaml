#!/usr/bin/env ansible-playbook
---
- hosts: all,!rtr,!sto,!swt,!vmm,!wifi,!dhcp,!vmm,!cfg  # Don't include stacked etcd
  become: yes
  serial: 1
  tasks:
  - name: Check if upgrade is available
    command: do-release-upgrade --check-dist-upgrade-only
    ignore_errors: True
    register: upgrade_available

  - name: Skip if no upgrade needed
    meta: end_host
    when: upgrade_available.rc != 0

  - name: Disable 3rd party sources to allow upgrade
    apt_repository:
      repo: "{{ item }}"
      state: absent
    loop:
      - deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
      - deb https://apt.kubernetes.io/ kubernetes-xenial main
    register: k8s_apt_repo

  - name: Disable 3rd party sources to allow upgrade
    apt_repository:
      repo: "{{ item }}"
      state: absent
    loop:
      - deb https://baltocdn.com/helm/stable/debian/ all main
    register: helm_apt_repo

  - name: Update package sources
    apt:
      autoclean: true
      update_cache: yes
      cache_valid_time: 86400  # one day

  - name: Apply dist upgrades
    apt:
      upgrade: dist

  - name: Apply upgrades
    apt:
      upgrade: yes

  - name: Fail host if reboot is required
    stat:
      path: /var/run/reboot-required
    register: reboot_required
    failed_when: reboot_required.stat.exists

  - name: Distribution upgrade
    command: do-release-upgrade -f DistUpgradeViewNonInteractive

  - name: Re-enable 3rd party sources
    apt_repository:
      repo: "{{ item }}"
      state: present
    loop:
      - deb [arch=amd64] https://download.docker.com/linux/ubuntu jammy stable
      - deb https://apt.kubernetes.io/ kubernetes-xenial main
    when: k8s_apt_repo.changed

  - name: Re-enable 3rd party sources to allow upgrade
    apt_repository:
      repo: "{{ item }}"
      state: present
    loop:
      - deb https://baltocdn.com/helm/stable/debian/ all main
    when: helm_apt_repo.changed

  - name: Reboot host and wait for it to restart
    reboot:
      msg: "Reboot initiated by Ansible"
      connect_timeout: 5
      reboot_timeout: 600
      pre_reboot_delay: 0
      post_reboot_delay: 30
      test_command: whoami
