# See commands in scripts/etcd-repair/ for the broader set of steps needed to provision
# a new etcd host. First run the cfg play, then run this to have the node join the cluster.
---
- hosts: cfg
  any_errors_fatal: yes
  tasks:
    - name: Join command to member to cluster
      command: "echo etcdctl member add {{ etcd_name }} --peer-urls=http://{{ etcd_ip }}:2380"
      delegate_to: localhost
      register: add

    - debug: var=add

- hosts: cfg
  become: yes
  vars_prompt:
    - name: join_prompt
      prompt: "Manually run join command above then. Press return to continue and restart etcd, or ctrl-c to abort"
      private: no
  tasks:
    - name: Restart etcd service
      systemd:
        name: etcd
        enabled: yes
        daemon_reload: yes
        # Getting quorum can take awhile
        no_block: yes
        state: started