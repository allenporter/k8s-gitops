---
- name: Create temporary build directory
  ansible.builtin.tempfile:
    state: directory
    suffix: build
  register: tempdirs

- name: Create output directory
  ansible.builtin.file:
    path: "{{ output_dir }}"
    state: directory
  run_once: true

- name: Build image
  vars:
    name: "{{ item.name }}"
    control_plane: "{{ item.control_plane }}"
    #item_build_dir: "{{ tempdirs.path }}/{{ item.name }}"
    item_build_dir: "{{ output_dir }}/{{ item.name }}"
    iso_file: "{{ output_dir }}/kairos-{{ item.name }}.iso"
    primary: "{{ item.primary is defined and item.primary }}"
    secondary: "{{ item.secondary is defined and item.secondary }}"
  include_tasks: build.yaml
  with_items: "{{ datasources }}"
