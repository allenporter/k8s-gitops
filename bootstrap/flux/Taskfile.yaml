version: '3'

vars:
  sops_gcloud_key: k8s-gitops-age-key
  flux_sops_secret_name: sops-age
  flux_namespace: flux-system

tasks:
  create-namespace:
    cmds:
      - kubectl create namespace {{.flux_namespace}}

  bootstrap-sops-key:
    cmds:
      - |
        gcloud secrets versions access 1 --secret={{.sops_gcloud_key}} --project=${GCLOUD_PROJECT_ID} | \
            kubectl create secret generic "{{.flux_sops_secret_name}}" --namespace="{{.secret_namespace}}" --from-file="{{.flux_sops_secret_name}}=/dev/stdin"

  install-flux:
    cmds:
      - kustomize build bootstrap/flux/manifests/ | kubectl apply -f -
